<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CodeFlow Dashboard</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: #0f172a;
      color: #e2e8f0;
      line-height: 1.6;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 2rem;
    }

    header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 2rem;
      border-radius: 12px;
      margin-bottom: 2rem;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }

    h1 {
      font-size: 2.5rem;
      margin-bottom: 0.5rem;
    }

    .subtitle {
      opacity: 0.9;
      font-size: 1.1rem;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .card {
      background: #1e293b;
      border-radius: 12px;
      padding: 1.5rem;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      border: 1px solid #334155;
    }

    .card h2 {
      font-size: 1.5rem;
      margin-bottom: 1rem;
      color: #a78bfa;
    }

    .stat {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem 0;
      border-bottom: 1px solid #334155;
    }

    .stat:last-child {
      border-bottom: none;
    }

    .stat-value {
      font-size: 1.5rem;
      font-weight: bold;
      color: #60a5fa;
    }

    .btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .repo-list {
      list-style: none;
    }

    .repo-item {
      background: #0f172a;
      padding: 1rem;
      margin-bottom: 0.75rem;
      border-radius: 8px;
      border-left: 4px solid #667eea;
    }

    .repo-name {
      font-weight: 600;
      color: #a78bfa;
      margin-bottom: 0.25rem;
    }

    .repo-type {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      background: #334155;
      border-radius: 4px;
      font-size: 0.875rem;
      margin-top: 0.5rem;
    }

    .dependency-graph {
      background: #0f172a;
      padding: 1.5rem;
      border-radius: 8px;
      margin-top: 1rem;
      font-family: 'Courier New', monospace;
      font-size: 0.9rem;
      overflow-x: auto;
    }

    .loading {
      text-align: center;
      padding: 2rem;
      color: #94a3b8;
    }

    .status-indicator {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 0.5rem;
    }

    .status-healthy {
      background: #10b981;
    }

    .status-warning {
      background: #f59e0b;
    }

    .status-error {
      background: #ef4444;
    }

    .actions {
      display: flex;
      gap: 1rem;
      margin-top: 1rem;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üöÄ CodeFlow Dashboard</h1>
      <p class="subtitle">AI-Powered Cross-Repo Dependency Manager</p>
    </header>

    <div class="grid">
      <div class="card">
        <h2>üìä System Status</h2>
        <div class="stat">
          <span><span class="status-indicator status-healthy"></span>API Status</span>
          <span class="stat-value" id="api-status">Checking...</span>
        </div>
        <div class="stat">
          <span>Total Repositories</span>
          <span class="stat-value" id="total-repos">-</span>
        </div>
        <div class="stat">
          <span>Providers</span>
          <span class="stat-value" id="total-providers">-</span>
        </div>
        <div class="stat">
          <span>Consumers</span>
          <span class="stat-value" id="total-consumers">-</span>
        </div>
        <div class="actions">
          <button class="btn" onclick="syncRepos()">üîÑ Sync Repos</button>
        </div>
      </div>

      <div class="card">
        <h2>üîó Repositories</h2>
        <ul class="repo-list" id="repo-list">
          <li class="loading">Loading repositories...</li>
        </ul>
      </div>
    </div>

    <div class="card">
      <h2>üï∏Ô∏è Dependency Graph</h2>
      <div class="dependency-graph" id="dependency-graph">
        <div class="loading">Loading dependency graph...</div>
      </div>
    </div>
  </div>

  <script>
    // Check API health
    async function checkHealth() {
      try {
        const response = await fetch('/api/health');
        const data = await response.json();
        document.getElementById('api-status').textContent = data.status === 'healthy' ? '‚úÖ Healthy' : '‚ùå Down';
      } catch (error) {
        document.getElementById('api-status').textContent = '‚ùå Down';
      }
    }

    // Load repositories
    async function loadRepos() {
      try {
        const response = await fetch('/api/repos');
        const repos = await response.json();
        
        document.getElementById('total-repos').textContent = repos.length;
        document.getElementById('total-providers').textContent = repos.filter(r => r.type === 'provider').length;
        document.getElementById('total-consumers').textContent = repos.filter(r => r.type === 'consumer').length;

        const repoList = document.getElementById('repo-list');
        repoList.innerHTML = repos.map(repo => `
          <li class="repo-item">
            <div class="repo-name">${repo.name}</div>
            <div>${repo.url}</div>
            <span class="repo-type">${repo.type}</span>
          </li>
        `).join('');
      } catch (error) {
        console.error('Failed to load repos:', error);
      }
    }

    // Load dependency graph
    async function loadDependencyGraph() {
      try {
        const response = await fetch('/api/dependency-graph');
        const graph = await response.json();
        
        let graphHtml = '';
        
        for (const [providerName, provider] of Object.entries(graph.providers)) {
          graphHtml += `üî∑ ${providerName} (Provider)\n`;
          provider.apis.forEach(api => {
            graphHtml += `   ‚îî‚îÄ ${api.method} ${api.endpoint}\n`;
          });
          
          if (provider.dependents.length > 0) {
            graphHtml += `   Consumed by:\n`;
            provider.dependents.forEach(dep => {
              graphHtml += `   ‚îî‚îÄ ${dep.service} ‚Üí ${dep.endpoint}\n`;
            });
          }
          graphHtml += '\n';
        }

        document.getElementById('dependency-graph').textContent = graphHtml || 'No dependencies found';
      } catch (error) {
        console.error('Failed to load dependency graph:', error);
      }
    }

    // Sync repositories
    async function syncRepos() {
      const btn = event.target;
      btn.disabled = true;
      btn.textContent = '‚è≥ Syncing...';

      try {
        const response = await fetch('/api/sync', { method: 'POST' });
        const data = await response.json();
        
        if (data.success) {
          btn.textContent = '‚úÖ Synced!';
          setTimeout(() => {
            btn.textContent = 'üîÑ Sync Repos';
            btn.disabled = false;
          }, 2000);
          
          loadRepos();
        } else {
          btn.textContent = '‚ùå Failed';
          setTimeout(() => {
            btn.textContent = 'üîÑ Sync Repos';
            btn.disabled = false;
          }, 2000);
        }
      } catch (error) {
        console.error('Sync failed:', error);
        btn.textContent = '‚ùå Failed';
        setTimeout(() => {
          btn.textContent = 'üîÑ Sync Repos';
          btn.disabled = false;
        }, 2000);
      }
    }

    // Initialize
    checkHealth();
    loadRepos();
    loadDependencyGraph();

    // Refresh every 30 seconds
    setInterval(checkHealth, 30000);
  </script>
</body>
</html>
